# Uniswap 

## 概述

Uniswap 是一个交换协议，它允许用户无信任地交换 ERC20 Token。与传统的订单薄(`order book`)模型不同，Uniswap 收集 token 到合约中，用户通过流动池进行交易。

本文旨在帮助你理解 Uniswap 在底层是如何工作的，虽然用户界面也许非常简单，但是在幕后有很多工作。

## ERC20 代币入门

ERC20 代币是以太坊链上最常见的代币类型，它们在本质上是可互换的，意味着各个代币之间是没有差别的。比如说，如果我有 100 个金属球，它们大小和颜色相同，那么不管我给你哪一个都是可以的。同样地，如果我有 100 个相同的 ERC20 代币，那么无论我给你哪一个，也都是一样的。这和 ERC721 代币形成了鲜明对比。

ERC20 可以被认为是最简单的**记账单位**(`account unit`)，其拥有广泛的使用场景：货币、奖励积分、债务单据等等。它们也是高度可分的，可以以很小的量进行发送。由于这种类型的代币如此普遍，因此拥有一个简单的方式来交换它们也显得非常重要。

## Uniswap 合约概览

当你浏览 Uniswap 站点时，记住：它实际做的工作远远多于你看到的用户界面。Uniswap 标准化了 ERC20 代币与一系列智能合约的交换方式，任何一个人都可以构建一个界面，并将其与这一些合约连接使用，就立即能够开始与任何一个使用 Uniswap 的人进行代币交换。

Uniswap **由两种合约构成**。第一个是**交换合约**（Exchange Contract)。交换合约持有一种特定代币和 Ether 构成的池，用户可以通过其进行交换。第二种是**工厂合约**(Factory Contract)，其负责创建新的 Exchange Contract，并且注册 ERC20 代币地址和其对应的交换合约地址。

在 Uniswap 上添加代币没有费用，任何人都可以调用 Factory Contract 来注册新代币。

## Liquidity Pools

Uniswap 的独特性在于它不使用传统的订单薄来获得资产的价格。在中心化交易所中，比如 Coinbase，一个资产的价格取决于某个人所愿意支付的最高价格以及某个人愿意出售的最低价格。    
Uniswap 使用交换合约来聚集 Ether 和特定的 ERC20 代币。当使用 Ether 交换代币时，Ether 被发送到合约的池中，同时对应的代币从池中返回给用户。最终，用户不需要为了交易而等待对手方或者担心指定价格。由于任何人都可以列出代币，并且用户不用担心与其他人匹配，因此在首次发行代币时很容易避免任何的引导问题。

交易时返回的代币数量基于一个自动的做商公式(`market maker formula`)。本质上，返回的代币数量取决于池中 Ether 和代币的比率。不管交易的大小，用户的交易都可以得到保障，因为当你在池的一侧添加的资产越多，曲线将推向另一种资产。这意味着，当相对于池的订单越大，随着比率沿着曲线移动，你所收到的利率将会更差。

但是如果用户仅仅是发送加密货币，如何保证 Ether 和代币的比率相对于外部市场是正确的？答案是流动池通过套利的人来维持相对于其他市场的比率。想象以天平来表示 DAI:ETH 流动池。当天平保持平衡时，池相对于中心化交易所有一个合适的价格。假设当前在中心化交易所 ETH 的价格是 $150，而对应的流动池 DAI:ETH 则会以 150:1 的比率工作。因此，我们的规模是平衡的，因为流动池与中心化交易所当前价格相匹配。

现在假设相对于中心化交易所，池中价格有一定变化，使得 ETH 价格为 $100，因为价格的偏移，我们现在可以看到天平失去了平衡，因为人们现在可以在 Uniswap 上以 1ETH 交换到 150 DAI，而在中心化交易所却能以 1ETH 换到 100 DAI.

最为回应，某个人现在可以将 ETH 放入池中，取出 DAI，然后将这些 DAI 在中心化交易所中售出来获得利润，再重复......他们可以一直这样做直到天平恢复平衡。

因此，三方套利在 Uniswap 维持正确的以太代币比率中扮演着一个非常重要的角色。


## ERC20 互相交换
当和一个单独的交换合约交互时，一个用户可以在 Ether 和一个特定的代币之间进行交换。然而，Uniswap 也允许用户直接在u一笔交易中使用 ERC20 互相交换。如，当用户拥有 DAI，并想要有一些 MKR，因此，这个用户可以调用`tokenToTokenSwap`函数，其将 DAI 添加到 DAI 池并将获得的 ETH 放入 MKR 池，最终返回 MKR 给最初发起交易的地址。

## Liquidity Providers
当一个特定的交换合约被创建时，其中的 token 和 ether 池是空的。第一个向合约汇入代币的人决定了 token 和 Ether 的比率。如果他存入的比率和当前市场的比率不同，于是就有了一个套利的可能。当流动性提供者向一个已经建立的池中添加流动性时，他们应该添加成比例的数量到池子中。如果他们不这样做，他们增加的流动性也会面临被套利的风险。

另一方面，更大的流动性池对于用户是有益的，因为它们允许更大的交易，而不会将代币与 ETH 的比率沿着曲线倾斜太远。Uniswap 通过协议收取费用，再用其奖励那些流动性提供者以激励用户增加流动性。以太币和代币之间的交易将收取 0.3% 的 fee，而代币与代币之间交易将会收取 0.6% 费用。

最后，被称为流动性代币的特殊 ERC20 代币会被铸造到提供商的地址，其数量与提供商所提供的流动性比例成比例。当用户想要获得他们提供的流动性与他们所获得的奖励累积费用，代币就会被销毁。
